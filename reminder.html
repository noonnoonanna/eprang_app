<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <title>이피랑 - 리마인더</title>

  <style>
  body[data-page="reminder"] main{
    padding:16px 14px 100px;
    width:100%;
    max-width:480px;
    margin:0 auto;
  }

  body[data-page="reminder"] .rm-card{
    border-radius:18px;
    background:#ffffff;
    border:1px solid #e5e7eb;
    box-shadow:0 4px 12px rgba(15,23,42,0.04);
    width:100%;
    padding:18px 16px;
    margin-bottom:14px;
  }

  body[data-page="reminder"] .rm-title{
    margin:0 0 8px;
    font-size:18px;
    font-weight:800;
    color:#111827;
    display:flex;
    align-items:center;
    gap:6px;
  }

  body[data-page="reminder"] .rm-title i{
    color:var(--acc);
  }

  body[data-page="reminder"] .rm-sub{
    margin:0 0 8px;
    font-size:13px;
    color:#6b7280;
    line-height:1.6;
  }

  body[data-page="reminder"] .rm-caption{
    margin:4px 0 0;
    font-size:11px;
    color:#9ca3af;
  }

  /* 캘린더 + 리스트 카드 */
  body[data-page="reminder"] .rm-calendar-wrap{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* 캘린더 헤더 */
  body[data-page="reminder"] .rm-cal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:6px;
  }

  body[data-page="reminder"] .rm-cal-month{
    font-size:14px;
    font-weight:700;
    color:#111827;
    display:flex;
    align-items:center;
    gap:6px;
  }

  body[data-page="reminder"] .rm-cal-month span{
    font-weight:800;
  }

  body[data-page="reminder"] .rm-cal-nav{
    display:flex;
    gap:4px;
    opacity:.4;
    pointer-events:none; /* 아직 월 이동은 미구현 - UI만 */
  }

  body[data-page="reminder"] .rm-cal-nav button{
    border:0;
    background:#f3f4f6;
    border-radius:999px;
    width:26px;
    height:26px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#6b7280;
  }

  /* 요일 행 */
  body[data-page="reminder"] .rm-cal-weekdays{
    display:grid;
    grid-template-columns:repeat(7,minmax(0,1fr));
    font-size:11px;
    color:#9ca3af;
    margin-bottom:4px;
  }

  body[data-page="reminder"] .rm-cal-weekdays span{
    text-align:center;
    padding:2px 0;
  }

  /* 날짜 그리드 */
  body[data-page="reminder"] .rm-cal-grid{
    display:grid;
    grid-template-columns:repeat(7,minmax(0,1fr));
    gap:2px;
  }

  body[data-page="reminder"] .rm-day{
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#9ca3af;
  }

  body[data-page="reminder"] .rm-day-num{
    position:relative;
    width:28px;
    height:28px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  body[data-page="reminder"] .rm-day--in-month{
    color:#4b5563;
    cursor:pointer;
  }

  body[data-page="reminder"] .rm-day--today .rm-day-num{
    border:1px solid var(--acc);
  }

  body[data-page="reminder"] .rm-day--has .rm-day-num::after{
    content:'';
    position:absolute;
    bottom:3px;
    left:50%;
    transform:translateX(-50%);
    width:5px;
    height:5px;
    border-radius:999px;
    background:var(--acc);
  }

  body[data-page="reminder"] .rm-day--selected .rm-day-num{
    background:#ecfdf3;
    color:#15803d;
    border:1px solid rgba(22,163,74,0.5);
  }

  /* 일정 리스트 */
  body[data-page="reminder"] .rm-list-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-top:10px;
    margin-bottom:4px;
  }

  body[data-page="reminder"] .rm-list-title{
    font-size:14px;
    font-weight:700;
    color:#111827;
  }

  body[data-page="reminder"] .rm-list-count{
    font-size:11px;
    color:#9ca3af;
  }

  body[data-page="reminder"] .rm-event-list{
    margin:4px 0 0;
    padding:0;
    list-style:none;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  body[data-page="reminder"] .rm-date-group{
    padding-top:6px;
    border-top:1px dashed #e5e7eb;
  }

  body[data-page="reminder"] .rm-date-label{
    font-size:12px;
    font-weight:700;
    color:#4b5563;
    margin-bottom:4px;
  }

  body[data-page="reminder"] .rm-event-item{
    border-radius:12px;
    border:1px solid #e5e7eb;
    background:#f9fafb;
    padding:8px 10px;
    font-size:12px;
    color:#374151;
    display:flex;
    flex-direction:column;
    gap:2px;
    cursor:pointer;
  }

  body[data-page="reminder"] .rm-event-item:hover{
    border-color:rgba(22,163,74,0.35);
    background:#ffffff;
    box-shadow:0 4px 12px rgba(22,163,74,0.08);
  }

  body[data-page="reminder"] .rm-event-main{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px;
  }

  body[data-page="reminder"] .rm-event-label{
    font-weight:700;
    color:#111827;
  }

  body[data-page="reminder"] .rm-event-tag{
    font-size:11px;
    color:#059669;
  }

  body[data-page="reminder"] .rm-event-meta{
    font-size:11px;
    color:#6b7280;
    display:flex;
    align-items:center;
    gap:8px;
  }

  body[data-page="reminder"] .rm-event-meta i{
    font-size:11px;
    color:#9ca3af;
  }

  body[data-page="reminder"] .rm-empty{
    margin-top:6px;
    font-size:12px;
    color:#9ca3af;
  }
  </style>
</head>

<body data-page="reminder">
  <div class="app">
    <header>
      <div class="bar">
        <div class="logo">
          <a href="home.html" style="all:unset;cursor:pointer">
            <img src="img/logo.png" alt="이피랑 로고" />
          </a>
        </div>
      </div>
    </header>

    <main>
      <!-- 상단 요약 -->
      <section class="rm-card">
        <h3 class="rm-title">
          <i class="fa-solid fa-bell"></i>
          <span>리마인더 (알림/일정 관리)</span>
        </h3>
        <p class="rm-sub">
          실내 스마트팜을 처음 시작하는 청년농·귀농인이 <strong>놓치기 쉬운 정책자금·견적/계약·시공·운영 초기의 핵심 일정</strong>을
          한 화면에서 관리하는 영역입니다.
        </p>
        <p class="rm-caption">
          정책자금 마감일, (주)그린 견적 유효 기간, 착공/준공 일정, 첫 수확 예상일 등을 프로젝트별로 정리해서 챙길 수 있어요.
        </p>
      </section>

      <!-- 캘린더 + 리스트 -->
      <section class="rm-card">
        <div class="rm-calendar-wrap">
          <!-- 캘린더 헤더 -->
          <div class="rm-cal-header">
            <div class="rm-cal-month">
              <i class="fa-regular fa-calendar"></i>
              <span id="rmMonthLabel">2025년 11월</span>
            </div>
            <div class="rm-cal-nav">
              <button type="button"><i class="fa-solid fa-chevron-left"></i></button>
              <button type="button"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
          </div>

          <!-- 요일 -->
          <div class="rm-cal-weekdays">
            <span>일</span><span>월</span><span>화</span><span>수</span><span>목</span><span>금</span><span>토</span>
          </div>

          <!-- 날짜 그리드 -->
          <div class="rm-cal-grid" id="rmCalendarGrid"></div>

          <!-- 리스트 헤더 -->
          <div class="rm-list-header">
            <div class="rm-list-title" id="rmListTitle">전체 일정</div>
            <div class="rm-list-count" id="rmListCount">0건</div>
          </div>

          <!-- 일정 리스트 -->
          <div id="rmEventContainer">
            <p class="rm-empty">등록된 프로젝트 기반 일정이 아직 없습니다. 설문을 완료하고 설계안을 저장하면 일정이 자동으로 생성됩니다.</p>
          </div>
        </div>
      </section>
    </main>

    <!-- 하단 버튼 바 -->
    <div class="bottom-bar">
      <button type="button" class="btn ghost" id="rmBtnHome">홈으로</button>
      <button type="button" class="btn acc" id="rmBtnProjects">프로젝트 목록</button>
    </div>
  </div>

  <!-- 공통 모달/토스트 레이어 -->
  <div id="overlay" class="overlay" onclick="closeModal && closeModal(event)"></div>
  <div id="modal" class="modal" style="display:none"></div>
  <div id="toast" class="toast">처리되었습니다</div>

  <script src="app.js" defer></script>
  <script>
  document.addEventListener('DOMContentLoaded',function(){
    // 하단 버튼
    var btnHome=document.getElementById('rmBtnHome');
    var btnProjects=document.getElementById('rmBtnProjects');
    if(btnHome){
      btnHome.addEventListener('click',function(){window.location.assign('home.html');});
    }
    if(btnProjects){
      btnProjects.addEventListener('click',function(){window.location.assign('home.html');});
    }

    // ==========================
    //  데이터 준비: ep-projects
    // ==========================
    var key=(window.K && K.PROJECTS) || 'ep-projects';
    var projects=[];
    try{
      projects = (typeof read === 'function') ? read(key, []) : JSON.parse(localStorage.getItem(key) || '[]');
    }catch(e){
      projects=[];
    }
    if(!Array.isArray(projects)) projects=[];

    // 프로젝트 기반 간단 리마인더 생성
    // 지금은 우리가 가진 게 createdAt 뿐이라
    // "설계 저장 / 견적 준비" 일정만 자동으로 만들고,
    // 나중에 정책자금/시공/운영일정 날짜 들어오면 이벤트만 추가하면 됨.
    var events=[];
    projects.forEach(function(p){
      if(!p || !p.createdAt) return;
      var dt=new Date(p.createdAt);
      if(isNaN(dt.getTime())) return;

      var y=dt.getFullYear();
      var m=('0'+(dt.getMonth()+1)).slice(-2);
      var d=('0'+dt.getDate()).slice(-2);
      var dateStr=y+'-'+m+'-'+d;

      var name=(p.reco && p.reco.title) || '이름 없는 프로젝트';

      events.push({
        projectId:p.id,
        projectName:name,
        date:dateStr,
        type:'contract',
        tag:'견적/계약',
        label:'설계 저장 · (주)그린 견적 준비',
        desc:'온보딩 설문과 추천 설계안을 바탕으로, (주)그린과의 첫 견적/상담을 준비하는 시점입니다.'
      });
    });

    // 그룹핑: 날짜별
    function groupByDate(evts){
      var map={};
      evts.forEach(function(e){
        if(!map[e.date]) map[e.date]=[];
        map[e.date].push(e);
      });
      return map;
    }

    var eventByDate=groupByDate(events);

    // 오늘/이번달 기준
    var today=new Date();
    var currentYear=today.getFullYear();
    var currentMonth=today.getMonth(); // 0~11

    // 월 라벨
    var monthLabel=document.getElementById('rmMonthLabel');
    function setMonthLabel(year,month){
      if(!monthLabel) return;
      monthLabel.textContent=year+'년 '+(month+1)+'월';
    }
    setMonthLabel(currentYear,currentMonth);

    // 캘린더 빌드
    var calGrid=document.getElementById('rmCalendarGrid');
    var selectedDate=null;

    function buildCalendar(year,month){
      if(!calGrid) return;
      calGrid.innerHTML='';

      var first=new Date(year,month,1);
      var firstDay=first.getDay(); // 0=일
      var lastDayCount=new Date(year,month+1,0).getDate();

      // 앞 공백
      for(var i=0;i<firstDay;i++){
        var empty=document.createElement('div');
        empty.className='rm-day';
        calGrid.appendChild(empty);
      }

      for(var d=1;d<=lastDayCount;d++){
        var cell=document.createElement('div');
        cell.className='rm-day rm-day--in-month';

        var numWrap=document.createElement('div');
        numWrap.className='rm-day-num';
        numWrap.textContent=d;

        var y=year;
        var m=('0'+(month+1)).slice(-2);
        var dd=('0'+d).slice(-2);
        var dateStr=y+'-'+m+'-'+dd;

        if(eventByDate[dateStr]){
          cell.classList.add('rm-day--has');
        }

        var isToday = (year===today.getFullYear() &&
                       month===today.getMonth() &&
                       d===today.getDate());
        if(isToday){
          cell.classList.add('rm-day--today');
        }

        if(selectedDate===dateStr){
          cell.classList.add('rm-day--selected');
        }

        cell.dataset.date=dateStr;
        cell.appendChild(numWrap);
        calGrid.appendChild(cell);
      }
    }

    // 리스트 렌더링
    var listTitle=document.getElementById('rmListTitle');
    var listCount=document.getElementById('rmListCount');
    var eventContainer=document.getElementById('rmEventContainer');

    function formatKoreanDate(dateStr){
      // "YYYY-MM-DD" -> "MM월 DD일(요일)"
      var parts=dateStr.split('-');
      if(parts.length!==3) return dateStr;
      var y=parseInt(parts[0],10);
      var m=parseInt(parts[1],10)-1;
      var d=parseInt(parts[2],10);
      var dt=new Date(y,m,d);
      if(isNaN(dt.getTime())) return dateStr;
      var weekday=['일','월','화','수','목','금','토'][dt.getDay()];
      return (m+1)+'월 '+d+'일('+weekday+')';
    }

    function renderList(filterDate){
      if(!eventContainer) return;

      var filtered = filterDate
        ? events.filter(function(e){return e.date===filterDate;})
        : events.slice().sort(function(a,b){return a.date.localeCompare(b.date);});

      // 헤더 텍스트
      if(filterDate){
        if(listTitle) listTitle.textContent=formatKoreanDate(filterDate)+' 일정';
      }else{
        if(listTitle) listTitle.textContent='전체 일정';
      }
      if(listCount) listCount.textContent=filtered.length+'건';

      if(!filtered.length){
        eventContainer.innerHTML='<p class="rm-empty">표시할 일정이 없습니다. 프로젝트 상세 화면에서 정책자금·계약·시공 일정을 채워 넣으면 이곳에 모아볼 수 있어요.</p>';
        return;
      }

      // 날짜별 정렬 후 그룹핑
      var byDate=groupByDate(filtered.slice().sort(function(a,b){return a.date.localeCompare(b.date);}));
      var dates=Object.keys(byDate).sort();
      var html='';

      dates.forEach(function(dateStr){
        html+='<div class="rm-date-group">';
        html+='<div class="rm-date-label">'+formatKoreanDate(dateStr)+'</div>';
        html+='<ul class="rm-event-list">';
        byDate[dateStr].forEach(function(ev,idx){
          var pid=ev.projectId || '';
          var safeName=ev.projectName || '이름 없는 프로젝트';
          html+='<li class="rm-event-item" data-project-id="'+pid+'" data-date="'+ev.date+'">';
          html+='<div class="rm-event-main">';
          html+='<span class="rm-event-label">'+ev.label+'</span>';
          html+='<span class="rm-event-tag">'+safeName+'</span>';
          html+='</div>';
          html+='<div class="rm-event-meta">';
          html+='<span><i class="fa-regular fa-bell"></i>'+ev.tag+'</span>';
          html+='</div>';
          html+='</li>';
        });
        html+='</ul></div>';
      });

      eventContainer.innerHTML=html;

      // 클릭 시 프로젝트 상세 이동
      var items=eventContainer.querySelectorAll('.rm-event-item');
      items.forEach(function(item){
        item.addEventListener('click',function(){
          var pid=this.dataset.projectId;
          if(pid){
            try{
              localStorage.setItem('ep-current-project-id',pid);
            }catch(e){}
            window.location.assign('project-detail.html');
          }else{
            if(typeof toast==='function'){
              toast('프로젝트 정보가 없습니다.');
            }else{
              alert('프로젝트 정보가 없습니다.');
            }
          }
        });
      });
    }

    // 캘린더와 리스트 초기 렌더
    buildCalendar(currentYear,currentMonth);
    renderList(null); // 전체 일정

    // 날짜 클릭 필터
    if(calGrid){
      calGrid.addEventListener('click',function(e){
        var day = e.target.closest('.rm-day--in-month');
        if(!day || !day.dataset.date) return;
        var dateStr=day.dataset.date;
        if(selectedDate===dateStr){
          // 한번 더 누르면 전체보기
          selectedDate=null;
        }else{
          selectedDate=dateStr;
        }
        buildCalendar(currentYear,currentMonth);
        renderList(selectedDate);
      });
    }
  });
  </script>
</body>
</html>
