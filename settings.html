<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <title>이피랑 - 설정</title>

  <style>
  body[data-page="settings"] main{
    padding:16px 14px 100px;
    width:100%;
    max-width:480px;
    margin:0 auto;
  }

  body[data-page="settings"] .st-card{
    border-radius:18px;
    background:#ffffff;
    border:1px solid #e5e7eb;
    box-shadow:0 4px 12px rgba(15,23,42,0.04);
    width:100%;
    padding:18px 16px;
    margin-bottom:14px;
  }

  body[data-page="settings"] .st-title{
    margin:0 0 8px;
    font-size:18px;
    font-weight:800;
    color:#111827;
    display:flex;
    align-items:center;
    gap:6px;
  }

  body[data-page="settings"] .st-title i{
    color:var(--acc);
  }

  body[data-page="settings"] .st-sub{
    margin:0 0 8px;
    font-size:13px;
    color:#6b7280;
    line-height:1.6;
  }

  body[data-page="settings"] .st-caption{
    margin:4px 0 0;
    font-size:11px;
    color:#9ca3af;
  }

  body[data-page="settings"] .st-section-title{
    margin:0 0 6px;
    font-size:14px;
    font-weight:700;
    color:#111827;
    display:flex;
    align-items:center;
    gap:6px;
  }

  body[data-page="settings"] .st-section-title i{
    font-size:13px;
    color:#9ca3af;
  }

  /* 폼 요소 */
  body[data-page="settings"] .st-field-group{
    margin-bottom:10px;
  }

  body[data-page="settings"] .st-label{
    display:block;
    margin-bottom:4px;
    font-size:13px;
    font-weight:600;
    color:#374151;
  }

  body[data-page="settings"] .st-input,
  body[data-page="settings"] .st-textarea{
    width:100%;
    border-radius:10px;
    border:1px solid #e5e7eb;
    padding:8px 9px;
    font-size:13px;
    color:#111827;
    background:#f9fafb;
  }

  body[data-page="settings"] .st-textarea{
    resize:vertical;
    min-height:60px;
  }

  body[data-page="settings"] .st-input:focus,
  body[data-page="settings"] .st-textarea:focus{
    outline:none;
    border-color:rgba(22,163,74,0.6);
    background:#ffffff;
    box-shadow:0 0 0 1px rgba(22,163,74,0.15);
  }

  body[data-page="settings"] .st-radio-row,
  body[data-page="settings"] .st-check-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    font-size:13px;
    color:#4b5563;
  }

  body[data-page="settings"] .st-radio-item,
  body[data-page="settings"] .st-check-item{
    display:flex;
    align-items:center;
    gap:4px;
  }

  body[data-page="settings"] .st-radio-item input,
  body[data-page="settings"] .st-check-item input{
    width:14px;
    height:14px;
  }

  body[data-page="settings"] .st-hint{
    margin-top:2px;
    font-size:11px;
    color:#9ca3af;
  }

  /* 알림 시간 */
  body[data-page="settings"] .st-time-row{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:13px;
  }

  body[data-page="settings"] .st-time-input{
    width:90px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    padding:6px 8px;
    font-size:13px;
    background:#f9fafb;
  }

  body[data-page="settings"] .st-time-input:focus{
    outline:none;
    border-color:rgba(22,163,74,0.6);
    background:#ffffff;
  }

  /* 약관/계정 관리 */
  body[data-page="settings"] .st-list{
    list-style:none;
    padding:0;
    margin:4px 0 0;
    font-size:13px;
    color:#4b5563;
  }

  body[data-page="settings"] .st-list li{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 0;
    border-top:1px solid #f3f4f6;
  }

  body[data-page="settings"] .st-list li:first-child{
    border-top:none;
  }

  body[data-page="settings"] .st-list-label{
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  body[data-page="settings"] .st-list-label span:first-child{
    font-weight:600;
  }

  body[data-page="settings"] .st-list-label span:last-child{
    font-size:11px;
    color:#9ca3af;
  }

  body[data-page="settings"] .st-link{
    font-size:12px;
    color:#2563eb;
    text-decoration:underline;
    cursor:pointer;
  }

  /* 위험 영역 */
  body[data-page="settings"] .st-danger{
    border-color:#fee2e2;
    background:#fef2f2;
  }

  body[data-page="settings"] .st-danger-title{
    color:#b91c1c;
  }

  body[data-page="settings"] .btn.danger{
    background:#ef4444;
    border-color:#ef4444;
    color:#ffffff;
  }

  body[data-page="settings"] .btn.danger.outline{
    background:#ffffff;
    border-color:#fecaca;
    color:#b91c1c;
  }
  </style>
</head>

<body data-page="settings">
  <div class="app">
    <header>
      <div class="bar">
        <div class="logo">
          <a href="intro.html" style="all:unset;cursor:pointer">
            <img src="img/logo.png" alt="이피랑 로고" />
          </a>
        </div>
      </div>
    </header>

    <main>
      <!-- 상단 개요 -->
      <section class="st-card">
        <h3 class="st-title">
          <i class="fa-solid fa-gear"></i>
          <span>설정</span>
        </h3>
        <p class="st-sub">
          계정·농장/사업자 정보, 알림, 파트너 코드, 약관 동의 내역 등을 한 곳에서 관리하는 화면입니다.
        </p>
        <p class="st-caption">
          입력하신 정보는 향후 정책자금 연계, (주)그린 견적/계약, 데이터 리포트 제공 시 참고용으로 사용됩니다.
        </p>
      </section>

      <!-- 프로필 / 농장 정보 -->
      <section class="st-card">
        <h3 class="st-section-title">
          <i class="fa-regular fa-id-card"></i>
          <span>프로필 / 농장 정보</span>
        </h3>

        <div class="st-field-group">
          <label class="st-label">구분</label>
          <div class="st-radio-row">
            <label class="st-radio-item">
              <input type="radio" name="stType" value="personal" checked />
              <span>개인</span>
            </label>
            <label class="st-radio-item">
              <input type="radio" name="stType" value="corporate" />
              <span>법인</span>
            </label>
          </div>
        </div>

        <div class="st-field-group">
          <label for="stName" class="st-label">상호 / 농장 이름</label>
          <input id="stName" class="st-input" type="text" placeholder="예: 김포 엽채 스마트팜" />
        </div>

        <div class="st-field-group">
          <label for="stBizNo" class="st-label">사업자등록번호</label>
          <input id="stBizNo" class="st-input" type="text" placeholder="예: 123-45-67890" />
          <div class="st-hint">개인 농장일 경우 필수가 아니며, 정책자금 연계 시 필요할 수 있습니다.</div>
        </div>

        <div class="st-field-group">
          <label for="stAddress" class="st-label">주소</label>
          <textarea id="stAddress" class="st-textarea" placeholder="예: 경기도 김포시 ○○로 123, 지식산업센터 3층"></textarea>
        </div>

        <div class="st-field-group">
          <label for="stManager" class="st-label">담당자 이름</label>
          <input id="stManager" class="st-input" type="text" placeholder="예: 홍길동" />
        </div>

        <div class="st-field-group">
          <label for="stPhone" class="st-label">담당자 연락처</label>
          <input id="stPhone" class="st-input" type="tel" placeholder="예: 010-0000-0000" />
        </div>

        <div class="st-field-group">
          <label for="stEmail" class="st-label">이메일</label>
          <input id="stEmail" class="st-input" type="email" placeholder="예: farm@example.com" />
          <div class="st-hint">견적서·계약서 안내, 데이터 리포트 제공 시 사용됩니다.</div>
        </div>
      </section>

      <!-- 알림 설정 -->
      <section class="st-card">
        <h3 class="st-section-title">
          <i class="fa-regular fa-bell"></i>
          <span>알림 설정</span>
        </h3>

        <div class="st-field-group">
          <label class="st-label">받을 알림 종류</label>
          <div class="st-check-row">
            <label class="st-check-item">
              <input type="checkbox" id="stNotiPolicy" />
              <span>정책자금</span>
            </label>
            <label class="st-check-item">
              <input type="checkbox" id="stNotiQuote" />
              <span>견적/계약</span>
            </label>
            <label class="st-check-item">
              <input type="checkbox" id="stNotiBuild" />
              <span>시공</span>
            </label>
            <label class="st-check-item">
              <input type="checkbox" id="stNotiOps" />
              <span>운영 초기</span>
            </label>
          </div>
          <div class="st-hint">향후 실제 알림 채널(앱 알림/SMS/이메일) 연동 시 이 설정이 기준이 됩니다.</div>
        </div>

        <div class="st-field-group">
          <label class="st-label">알림 받기 좋은 시간대</label>
          <div class="st-time-row">
            <span>주로</span>
            <select id="stNotiTime" class="st-time-input">
              <option value="morning">오전 (09:00 ~ 12:00)</option>
              <option value="afternoon">오후 (13:00 ~ 18:00)</option>
              <option value="evening">저녁 (18:00 ~ 21:00)</option>
              <option value="any">상관없음</option>
            </select>
            <span>에 알림 받기</span>
          </div>
        </div>
      </section>

      <!-- 파트너 코드 -->
      <section class="st-card">
        <h3 class="st-section-title">
          <i class="fa-solid fa-user-group"></i>
          <span>파트너 코드</span>
        </h3>

        <div class="st-field-group">
          <label for="stPartnerCode" class="st-label">파트너 코드</label>
          <input id="stPartnerCode" class="st-input" type="text" placeholder="예: EPGREEN-001" />
          <div class="st-hint">
            (주)이피랑–(주)그린 내부에서 프로젝트를 공유하거나, 특정 파트너 채널을 구분할 때 사용하는 코드입니다.
            일반 사용자라면 비워 두셔도 됩니다.
          </div>
        </div>
      </section>

      <!-- 약관 / 동의 / 계정 -->
      <section class="st-card">
        <h3 class="st-section-title">
          <i class="fa-regular fa-file-lines"></i>
          <span>약관 · 동의 내역</span>
        </h3>

        <ul class="st-list">
          <li>
            <div class="st-list-label">
              <span>서비스 이용약관</span>
              <span>설문 시작 시 동의한 이용약관입니다.</span>
            </div>
            <span class="st-link" id="stLinkTerms">보기</span>
          </li>
          <li>
            <div class="st-list-label">
              <span>개인정보 수집·이용 동의</span>
              <span>설문·프로젝트 관리에 필요한 최소 범위입니다.</span>
            </div>
            <span class="st-link" id="stLinkPrivacy">보기</span>
          </li>
          <li>
            <div class="st-list-label">
              <span>데이터 활용 동의(선택)</span>
              <span>익명화된 데이터로 정책·연구·제품 기획에 활용될 수 있습니다.</span>
            </div>
            <span class="st-link" id="stLinkData">보기</span>
          </li>
        </ul>
      </section>

      <!-- 계정 삭제 / 데이터 다운로드 -->
      <section class="st-card st-danger">
        <h3 class="st-section-title st-danger-title">
          <i class="fa-regular fa-circle-xmark"></i>
          <span>계정 삭제 / 데이터 다운로드</span>
        </h3>

        <p class="st-sub" style="font-size:12px;color:#7f1d1d;">
          데이터 비즈니스·신뢰 확보를 위해, 내 프로젝트·설문·설계 데이터를 한 번에 내려받거나 삭제할 수 있는 기능을 제공합니다.
          실제 운영 시에는 본인 확인 절차와 별도 문의 채널을 통해 처리될 수 있습니다.
        </p>

        <div class="st-field-group">
          <button type="button" class="btn danger outline" id="stBtnExport">데이터 다운로드 (로컬 기기)</button>
        </div>
        <div class="st-field-group">
          <button type="button" class="btn danger" id="stBtnDelete">계정 / 데이터 삭제 요청</button>
          <div class="st-hint">
            현재는 이 기기에 저장된 설문·프로젝트 데이터를 초기화하는 수준으로 동작합니다.
            실제 서비스에서는 별도 본인 인증 후 처리됩니다.
          </div>
        </div>
      </section>
    </main>

    <!-- 하단 버튼 바 -->
    <div class="bottom-bar">
      <button type="button" class="btn ghost" id="stBtnHome">홈으로</button>
      <button type="button" class="btn acc" id="stBtnSave">설정 저장</button>
    </div>
  </div>

  <!-- 공통 모달/토스트 -->
  <div id="overlay" class="overlay" onclick="closeModal && closeModal(event)"></div>
  <div id="modal" class="modal" style="display:none"></div>
  <div id="toast" class="toast">처리되었습니다</div>

  <script src="app.js" defer></script>
  <script>
  document.addEventListener('DOMContentLoaded',function(){
    // 하단 버튼
    var btnHome=document.getElementById('stBtnHome');
    var btnSave=document.getElementById('stBtnSave');
    if(btnHome){
      btnHome.addEventListener('click',function(){window.location.assign('home.html');});
    }

    // 키 정의
    var settingsKey=(window.K && K.SETTINGS) || 'ep-settings';

    function safeRead(key, fallback){
      try{
        if(typeof read==='function'){
          return read(key,fallback);
        }
        var raw=localStorage.getItem(key);
        if(!raw) return fallback;
        var parsed=JSON.parse(raw);
        return (parsed===null || parsed===undefined)?fallback:parsed;
      }catch(e){
        return fallback;
      }
    }

    function safeWrite(key, value){
      try{
        if(typeof write==='function'){
          write(key,value);
        }else{
          localStorage.setItem(key,JSON.stringify(value));
        }
      }catch(e){
        console.error('settings save error',e);
      }
    }

    // 요소 모음
    var elName=document.getElementById('stName');
    var elBizNo=document.getElementById('stBizNo');
    var elAddr=document.getElementById('stAddress');
    var elManager=document.getElementById('stManager');
    var elPhone=document.getElementById('stPhone');
    var elEmail=document.getElementById('stEmail');

    var elNotiPolicy=document.getElementById('stNotiPolicy');
    var elNotiQuote=document.getElementById('stNotiQuote');
    var elNotiBuild=document.getElementById('stNotiBuild');
    var elNotiOps=document.getElementById('stNotiOps');
    var elNotiTime=document.getElementById('stNotiTime');
    var elPartner=document.getElementById('stPartnerCode');

    // 기존 값 로드
    var settings=safeRead(settingsKey,{}) || {};
    var profile=settings.profile || {};
    var noti=settings.notifications || {};
    var partner=settings.partner || {};

    // 프로필
    if(profile.type){
      var radios=document.querySelectorAll('input[name="stType"]');
      radios.forEach(function(r){
        r.checked=(r.value===profile.type);
      });
    }
    if(elName && profile.name) elName.value=profile.name;
    if(elBizNo && profile.bizNo) elBizNo.value=profile.bizNo;
    if(elAddr && profile.address) elAddr.value=profile.address;
    if(elManager && profile.manager) elManager.value=profile.manager;
    if(elPhone && profile.phone) elPhone.value=profile.phone;
    if(elEmail && profile.email) elEmail.value=profile.email;

    // 알림
    if(elNotiPolicy) elNotiPolicy.checked=!!noti.policy;
    if(elNotiQuote) elNotiQuote.checked=!!noti.quote;
    if(elNotiBuild) elNotiBuild.checked=!!noti.build;
    if(elNotiOps) elNotiOps.checked=!!noti.ops;
    if(elNotiTime && noti.time){
      elNotiTime.value=noti.time;
    }

    // 파트너
    if(elPartner && partner.code) elPartner.value=partner.code;

    // 저장
    if(btnSave){
      btnSave.addEventListener('click',function(){
        var type='personal';
        var radios=document.querySelectorAll('input[name="stType"]');
        radios.forEach(function(r){
          if(r.checked) type=r.value;
        });

        var newSettings={
          profile:{
            type:type,
            name:elName ? elName.value.trim() : '',
            bizNo:elBizNo ? elBizNo.value.trim() : '',
            address:elAddr ? elAddr.value.trim() : '',
            manager:elManager ? elManager.value.trim() : '',
            phone:elPhone ? elPhone.value.trim() : '',
            email:elEmail ? elEmail.value.trim() : ''
          },
          notifications:{
            policy:elNotiPolicy ? elNotiPolicy.checked : false,
            quote:elNotiQuote ? elNotiQuote.checked : false,
            build:elNotiBuild ? elNotiBuild.checked : false,
            ops:elNotiOps ? elNotiOps.checked : false,
            time:elNotiTime ? elNotiTime.value : 'morning'
          },
          partner:{
            code:elPartner ? elPartner.value.trim() : ''
          }
        };

        safeWrite(settingsKey,newSettings);
        if(typeof toast==='function'){
          toast('설정이 저장되었습니다.');
        }else{
          alert('설정이 저장되었습니다.');
        }
      });
    }

    // 약관 링크 (지금은 terms.html / privacy.html 같은 곳으로 연결 가정)
    var linkTerms=document.getElementById('stLinkTerms');
    var linkPrivacy=document.getElementById('stLinkPrivacy');
    var linkData=document.getElementById('stLinkData');

    if(linkTerms){
      linkTerms.addEventListener('click',function(){
        window.location.assign('terms.html');
      });
    }
    if(linkPrivacy){
      linkPrivacy.addEventListener('click',function(){
        window.location.assign('privacy.html'); // 없으면 terms.html로 바꿔도 됨
      });
    }
    if(linkData){
      linkData.addEventListener('click',function(){
        if(typeof openTerms==='function'){
          openTerms('데이터 활용 동의(예시)','익명화된 실내 스마트팜 운영 데이터가 정책·연구·제품 기획에 활용될 수 있습니다.\n\n실제 서비스에서는 별도 전문을 제공합니다.');
        }else{
          alert('데이터 활용 동의 전문은 추후 제공될 예정입니다.');
        }
      });
    }

    // 데이터 다운로드 (단순 JSON export)
    var btnExport=document.getElementById('stBtnExport');
    if(btnExport){
      btnExport.addEventListener('click',function(){
        try{
          var keyProj=(window.K && K.PROJECTS) || 'ep-projects';
          var projects=safeRead(keyProj,[]);
          var data={
            exportedAt:new Date().toISOString(),
            settings:safeRead(settingsKey,{}),
            projects:projects
          };
          var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
          var url=URL.createObjectURL(blob);
          var a=document.createElement('a');
          a.href=url;
          a.download='eprang-data-export.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          if(typeof toast==='function'){
            toast('데이터 파일을 다운로드했습니다.');
          }
        }catch(e){
          console.error(e);
          if(typeof toast==='function'){
            toast('데이터 다운로드 중 오류가 발생했습니다.');
          }else{
            alert('데이터 다운로드 중 오류가 발생했습니다.');
          }
        }
      });
    }

    // 계정/데이터 삭제 (로컬 초기화 수준)
    var btnDelete=document.getElementById('stBtnDelete');
    if(btnDelete){
      btnDelete.addEventListener('click',function(){
        var ok=confirm('이 기기에 저장된 설문·프로젝트·설정 데이터를 삭제하시겠습니까?\n실제 서비스에서는 별도 본인 확인 절차가 필요합니다.');
        if(!ok) return;
        try{
          var keyProj=(window.K && K.PROJECTS) || 'ep-projects';
          if(typeof write==='function'){
            write(keyProj,[]);
            write(settingsKey,{});
          }else{
            localStorage.removeItem(keyProj);
            localStorage.removeItem(settingsKey);
          }
          if(typeof toast==='function'){
            toast('이 기기에 저장된 데이터가 초기화되었습니다.');
          }else{
            alert('이 기기에 저장된 데이터가 초기화되었습니다.');
          }
        }catch(e){
          console.error(e);
          if(typeof toast==='function'){
            toast('데이터 삭제 중 오류가 발생했습니다.');
          }else{
            alert('데이터 삭제 중 오류가 발생했습니다.');
          }
        }
      });
    }
  });
  </script>
</body>
</html>
